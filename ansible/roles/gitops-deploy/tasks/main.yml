---
# Deploy GitOps (ArgoCD + App-of-Apps)

- name: Add ArgoCD Helm repository
  ansible.builtin.command:
    cmd: helm repo add argo {{ argocd_helm_repo }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: helm_repo_add
  changed_when: "'has been added' in helm_repo_add.stdout"
  failed_when: false

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Check if ArgoCD is already installed
  ansible.builtin.command:
    cmd: helm list -n {{ argocd_namespace }} -o json
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: argocd_helm_check
  changed_when: false
  failed_when: false

- name: Parse ArgoCD installation status
  ansible.builtin.set_fact:
    argocd_installed: "{{ (argocd_helm_check.stdout | from_json | selectattr('name', 'equalto', 'argocd') | list | length > 0) if argocd_helm_check.rc == 0 else false }}"

- name: Display ArgoCD installation status
  ansible.builtin.debug:
    msg: "{{ '✓ ArgoCD already installed, skipping installation' if argocd_installed else '⚙️  Installing ArgoCD via Helm' }}"

- name: Create ArgoCD namespace
  ansible.builtin.command:
    cmd: kubectl create namespace {{ argocd_namespace }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  when: not argocd_installed
  register: create_ns
  changed_when: create_ns.rc == 0
  failed_when: create_ns.rc != 0 and 'already exists' not in create_ns.stderr

- name: Install ArgoCD using Helm
  ansible.builtin.command:
    cmd: >
      helm install argocd argo/{{ argocd_helm_chart }}
      --namespace {{ argocd_namespace }}
      --version {{ argocd_helm_version }}
      --set server.service.type=ClusterIP
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  when: not argocd_installed
  changed_when: true
  register: argocd_install_result

- name: Wait for ArgoCD server to be ready
  ansible.builtin.command:
    cmd: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout={{ wait_timeout_argocd }}s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Wait for ArgoCD repo server to be ready
  ansible.builtin.command:
    cmd: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-repo-server -n argocd --timeout={{ wait_timeout_argocd }}s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Wait for ArgoCD application controller to be ready
  ansible.builtin.command:
    cmd: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout={{ wait_timeout_argocd }}s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Wait additional time for ArgoCD to fully initialize
  ansible.builtin.pause:
    seconds: 30

- name: Check if app-of-apps already exists
  ansible.builtin.command:
    cmd: kubectl get application app-of-apps -n argocd
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: app_of_apps_check
  changed_when: false
  failed_when: false

- name: Display app-of-apps deployment status
  ansible.builtin.debug:
    msg: "{{ '✓ App-of-apps already deployed, skipping' if app_of_apps_check.rc == 0 else '⚙️  Deploying app-of-apps' }}"

- name: Apply app-of-apps manifest
  ansible.builtin.command:
    cmd: kubectl apply -f {{ app_of_apps_manifest }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  when: app_of_apps_check.rc != 0
  changed_when: true

- name: Get ArgoCD applications status
  ansible.builtin.command:
    cmd: kubectl get applications -n argocd
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: argocd_apps
  changed_when: false

- name: Display GitOps deployment summary
  ansible.builtin.debug:
    msg: |

      ╔═══════════════════════════════════════════════════════════════╗
      ║                 GITOPS DEPLOYMENT COMPLETE!                  ║
      ╚═══════════════════════════════════════════════════════════════╝

      ArgoCD Details:
        • Namespace: argocd
        • Installed via: Helm ({{ argocd_helm_version }})
        • App-of-Apps: Deployed
        • Repository: https://github.com/jamilshaikh07/talos-proxmox-gitops

      ArgoCD Applications:
      {{ argocd_apps.stdout }}

      Next Steps:
        1. Get ArgoCD admin password:
           kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
        2. Port forward ArgoCD UI:
           kubectl port-forward svc/argocd-server -n argocd 8080:443
        3. Access ArgoCD UI: https://localhost:8080
        4. Login with username: admin and the password from step 1
