---
# Install Cilium CNI

- name: Add Cilium Helm repository
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"

- name: Install Cilium CNI
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_version }}"
    release_namespace: kube-system
    update_repo_cache: true
    values:
      ipam:
        mode: kubernetes
      kubeProxyReplacement: false
      securityContext:
        capabilities:
          ciliumAgent:
            - CHOWN
            - KILL
            - NET_ADMIN
            - NET_RAW
            - IPC_LOCK
            - SYS_ADMIN
            - SYS_RESOURCE
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
          cleanCiliumState:
            - NET_ADMIN
            - SYS_ADMIN
            - SYS_RESOURCE
      cgroup:
        autoMount:
          enabled: false
        hostRoot: /sys/fs/cgroup
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"

- name: Wait for Cilium pods to be ready
  ansible.builtin.command:
    cmd: kubectl wait --for=condition=ready pod -l k8s-app=cilium -n kube-system --timeout={{ wait_timeout_cilium }}s
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Calculate expected node count
  ansible.builtin.set_fact:
    expected_nodes: "{{ 1 + (talos_nodes.workers | length) }}"

- name: Wait for all nodes to become Ready (now that CNI is installed)
  ansible.builtin.command:
    cmd: kubectl get nodes --no-headers
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: nodes_ready_status
  until: >
    nodes_ready_status.stdout_lines | length == expected_nodes | int and
    nodes_ready_status.stdout is search('NotReady') == false
  retries: 30
  delay: 10
  changed_when: false

- name: Display final cluster status
  ansible.builtin.debug:
    msg: |
      ✓ Cilium CNI installed and ready
      ✓ All {{ expected_nodes }} nodes are now Ready:
      {{ nodes_ready_status.stdout }}
