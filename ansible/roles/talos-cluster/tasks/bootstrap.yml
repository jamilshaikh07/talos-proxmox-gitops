---
# Bootstrap Talos Kubernetes cluster

- name: Set TALOSCONFIG environment variable
  ansible.builtin.set_fact:
    talosconfig_path: "{{ talos_config_dir }}/rendered/talosconfig"

- name: Configure talosctl endpoint
  ansible.builtin.command:
    cmd: talosctl config endpoint {{ talos_nodes.control_plane.ip }}
  environment:
    TALOSCONFIG: "{{ talosconfig_path }}"
  changed_when: true

- name: Configure talosctl node
  ansible.builtin.command:
    cmd: talosctl config node {{ talos_nodes.control_plane.ip }}
  environment:
    TALOSCONFIG: "{{ talosconfig_path }}"
  changed_when: true

- name: Check if nodes are reachable via talosctl
  ansible.builtin.command:
    cmd: talosctl version --short
  environment:
    TALOSCONFIG: "{{ talosconfig_path }}"
  register: talos_version_check
  until: talos_version_check.rc == 0
  retries: 20
  delay: 10
  changed_when: false
  failed_when: false

- name: Display Talos version
  ansible.builtin.debug:
    msg: |
      {{ '✓ Talos nodes are reachable' if talos_version_check.rc == 0 else '❌ Talos nodes not reachable' }}
      Client: {{ talos_version_check.stdout_lines[0] if talos_version_check.stdout_lines | length > 0 else 'unknown' }}
      Server: {{ talos_version_check.stdout_lines[1] if talos_version_check.stdout_lines | length > 1 else 'unknown' }}

- name: Fail if nodes not reachable
  ansible.builtin.fail:
    msg: "Talos nodes are not reachable after waiting"
  when: talos_version_check.rc != 0

- name: Bootstrap Kubernetes cluster
  ansible.builtin.command:
    cmd: talosctl bootstrap
  environment:
    TALOSCONFIG: "{{ talosconfig_path }}"
  changed_when: true
  register: bootstrap_result
  failed_when: false

- name: Display bootstrap result
  ansible.builtin.debug:
    msg: "{{ '✓ Bootstrap command executed (cluster may already be bootstrapped)' if bootstrap_result.rc == 0 else '⚠️  Bootstrap returned non-zero (may already be bootstrapped): ' ~ bootstrap_result.stderr }}"

- name: Wait for etcd to be running (be patient, this can take 2-3 minutes)
  ansible.builtin.command:
    cmd: talosctl service etcd status
  environment:
    TALOSCONFIG: "{{ talosconfig_path }}"
  register: etcd_status
  until: etcd_status.stdout is search('STATE.*Running')
  retries: 30
  delay: 10
  changed_when: false
  failed_when: false

- name: Display etcd status
  ansible.builtin.debug:
    msg: "{{ '✓ etcd is running' if etcd_status.rc == 0 else '⚠️  etcd status check timed out (cluster may still be initializing)' }}"
