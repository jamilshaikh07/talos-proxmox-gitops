---
# Generate Talos configuration

- name: Create Talos configuration directory
  ansible.builtin.file:
    path: "{{ talos_config_dir }}"
    state: directory
    mode: '0755'

- name: Check if secrets.yaml already exists
  ansible.builtin.stat:
    path: "{{ talos_config_dir }}/secrets.yaml"
  register: secrets_file

- name: Display secrets status
  ansible.builtin.debug:
    msg: "{{ '✓ Using existing secrets.yaml' if secrets_file.stat.exists else '⚙️  Generating new secrets.yaml' }}"

- name: Generate Talos secrets
  ansible.builtin.command:
    cmd: talosctl gen secrets
    chdir: "{{ talos_config_dir }}"
  when: not secrets_file.stat.exists
  changed_when: true

- name: Create CNI configuration patch
  ansible.builtin.copy:
    content: |
      cluster:
        network:
          cni:
            name: {{ cni_name }}
    dest: "{{ talos_config_dir }}/cni.yaml"
    mode: '0644'

- name: Create control plane scheduling patch
  ansible.builtin.copy:
    content: |
      cluster:
        allowSchedulingOnControlPlanes: {{ allow_scheduling_on_control_planes | lower }}
    dest: "{{ talos_config_dir }}/allowcontrolplanes.yaml"
    mode: '0644'

- name: Create installer image version patch
  ansible.builtin.copy:
    content: |
      machine:
        install:
          image: ghcr.io/siderolabs/installer:v{{ talos_version }}
    dest: "{{ talos_config_dir }}/installer-version.yaml"
    mode: '0644'

- name: Create kubelet certificate rotation patch
  ansible.builtin.copy:
    content: |
      machine:
        kubelet:
          extraArgs:
            rotate-server-certificates: "true"
    dest: "{{ talos_config_dir }}/kubelet-certs.yaml"
    mode: '0644'

- name: Create kubelet cert approver patch
  ansible.builtin.copy:
    content: |
      cluster:
        extraManifests:
          - https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/main/deploy/standalone-install.yaml
    dest: "{{ talos_config_dir }}/kubelet-cert-approver.yaml"
    mode: '0644'

- name: Create system extensions and Longhorn support patch
  ansible.builtin.copy:
    content: |
      # Patch for Proxmox and Longhorn
      customization:
        systemExtensions:
          officialExtensions:
            # For QEMU support with Proxmox
            - siderolabs/qemu-guest-agent
            # Longhorn support
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
      machine:
        features:
          # KubePrism: Local load balancer for Kubernetes API server
          # Provides HA and automatic failover for API access
          kubePrism:
            enabled: true
            port: 7445
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/lib/longhorn
              options:
                - bind
                - rshared
                - rw
    dest: "{{ talos_config_dir }}/longhorn-support.yaml"
    mode: '0644'

- name: Create control plane hostname patch
  ansible.builtin.copy:
    content: |
      machine:
        network:
          hostname: {{ talos_nodes.control_plane.hostname }}
    dest: "{{ talos_config_dir }}/controlplane-hostname.yaml"
    mode: '0644'

- name: Create worker hostname patches
  ansible.builtin.copy:
    content: |
      machine:
        network:
          hostname: {{ item.hostname }}
    dest: "{{ talos_config_dir }}/{{ item.hostname }}-hostname.yaml"
    mode: '0644'
  loop: "{{ talos_nodes.workers }}"

- name: Check if rendered configs already exist
  ansible.builtin.stat:
    path: "{{ talos_config_dir }}/rendered/controlplane.yaml"
  register: rendered_config

- name: Display config generation status
  ansible.builtin.debug:
    msg: "{{ '✓ Using existing rendered configs' if rendered_config.stat.exists else '⚙️  Generating new Talos configs' }}"

- name: Generate base Talos configuration for control plane
  ansible.builtin.command:
    cmd: >
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
      --with-secrets secrets.yaml
      --talos-version v{{ talos_version }}
      --kubernetes-version v{{ kubernetes_version }}
      --config-patch @cni.yaml
      --config-patch @allowcontrolplanes.yaml
      --config-patch @installer-version.yaml
      --config-patch @kubelet-certs.yaml
      --config-patch @kubelet-cert-approver.yaml
      --config-patch @longhorn-support.yaml
      --config-patch-control-plane @controlplane-hostname.yaml
      --output rendered-cp
    chdir: "{{ talos_config_dir }}"
  when: not rendered_config.stat.exists
  changed_when: true

- name: Generate Talos configuration for workers
  ansible.builtin.command:
    cmd: >
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
      --with-secrets secrets.yaml
      --talos-version v{{ talos_version }}
      --kubernetes-version v{{ kubernetes_version }}
      --config-patch @cni.yaml
      --config-patch @allowcontrolplanes.yaml
      --config-patch @installer-version.yaml
      --config-patch @kubelet-certs.yaml
      --config-patch @kubelet-cert-approver.yaml
      --config-patch @longhorn-support.yaml
      --config-patch-worker @{{ item.hostname }}-hostname.yaml
      --output rendered-{{ item.hostname }}
    chdir: "{{ talos_config_dir }}"
  loop: "{{ talos_nodes.workers }}"
  when: not rendered_config.stat.exists
  changed_when: true

- name: Create final rendered directory
  ansible.builtin.file:
    path: "{{ talos_config_dir }}/rendered"
    state: directory
    mode: '0755'

- name: Copy control plane config to rendered directory
  ansible.builtin.copy:
    src: "{{ talos_config_dir }}/rendered-cp/controlplane.yaml"
    dest: "{{ talos_config_dir }}/rendered/controlplane.yaml"
    mode: '0644'
    remote_src: true
  when: not rendered_config.stat.exists

- name: Copy worker configs to rendered directory
  ansible.builtin.copy:
    src: "{{ talos_config_dir }}/rendered-{{ item.hostname }}/worker.yaml"
    dest: "{{ talos_config_dir }}/rendered/{{ item.hostname }}.yaml"
    mode: '0644'
    remote_src: true
  loop: "{{ talos_nodes.workers }}"
  when: not rendered_config.stat.exists

- name: Copy talosconfig to rendered directory
  ansible.builtin.copy:
    src: "{{ talos_config_dir }}/rendered-cp/talosconfig"
    dest: "{{ talos_config_dir }}/rendered/talosconfig"
    mode: '0644'
    remote_src: true
  when: not rendered_config.stat.exists

- name: Display configuration generation result
  ansible.builtin.debug:
    msg: "{{ '✓ Talos configuration ready (using existing)' if rendered_config.stat.exists else '✓ Talos configuration generated' }} in {{ talos_config_dir }}/rendered"
