---
# Export kubeconfig for kubectl access

- name: Export kubeconfig
  ansible.builtin.command:
    cmd: talosctl kubeconfig rendered/kubeconfig
  args:
    chdir: "{{ talos_config_dir }}"
  environment:
    TALOSCONFIG: "{{ talos_config_dir }}/rendered/talosconfig"
  changed_when: true

- name: Verify kubeconfig was created
  ansible.builtin.stat:
    path: "{{ talos_config_dir }}/rendered/kubeconfig"
  register: kubeconfig_stat
  failed_when: not kubeconfig_stat.stat.exists

- name: Display kubeconfig path
  ansible.builtin.debug:
    msg: "Using kubeconfig: {{ talos_config_dir }}/rendered/kubeconfig"

- name: Calculate expected node count
  ansible.builtin.set_fact:
    expected_nodes: "{{ 1 + (talos_nodes.workers | length) }}"

- name: Wait for Kubernetes API and nodes to register ({{ expected_nodes }} nodes expected)
  ansible.builtin.command:
    cmd: kubectl get nodes --no-headers
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
    PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
  register: nodes_status
  until: nodes_status.rc == 0 and nodes_status.stdout_lines | length == expected_nodes | int
  retries: 40
  delay: 15
  changed_when: false
  failed_when: false

- name: Display nodes status before CNI installation
  ansible.builtin.debug:
    msg: |
      Nodes registered with API server ({{ nodes_status.stdout_lines | length }}/{{ expected_nodes }}):
      {{ nodes_status.stdout }}
      ⚠️  Note: Nodes will be NotReady until Cilium CNI is installed

- name: Fail if all {{ expected_nodes }} nodes are not registered
  ansible.builtin.fail:
    msg: "Expected {{ expected_nodes }} nodes to register, but found {{ nodes_status.stdout_lines | default([]) | length }}"
  when: nodes_status.stdout_lines | default([]) | length != expected_nodes | int

- name: Copy kubeconfig to config (for kubectl default path)
  ansible.builtin.copy:
    src: "{{ talos_config_dir }}/rendered/kubeconfig"
    dest: "{{ talos_config_dir }}/rendered/config"
    remote_src: true
    mode: '0777'
  become: true

- name: Display kubeconfig location
  ansible.builtin.debug:
    msg: "✓ Kubeconfig exported to {{ talos_config_dir }}/rendered/kubeconfig and {{ talos_config_dir }}/rendered/config"
